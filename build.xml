<?xml version="1.0" ?>

<!--
 Copyright (C) 2013 Quoc-Sang Phan
 
 This file is part of jpf-bmc, an extension of Java Pathfinder for automated analysis
 of programs in Java bytecode using Bounded Model Checking.
 
 jpf-bmc is free software: you can redistribute it and/or modify it under the
 terms of the GNU General Public License as published by the Free Software
 Foundation, either version 3 of the License, or (at your option) any later
 version.
 
 jpf-bmc is distributed in the hope that it will be useful, but WITHOUT ANY
 WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR
 A PARTICULAR PURPOSE.  See the GNU General Public License for more details.
 
 You should have received a copy of the GNU General Public License along with
 jpf-bmc. If not, see <http://www.gnu.org/licenses/>.
-->

<!--
  build.xml - generic JPF extension build script
              using Ant (http://jakarta.apache.org/ant)
  public targets:

    compile           compile JPF and its specific (modeled) environment libraries
    test              run all JPF tests
    jar               build JPF jar files
    dist              build binary distribution
    clean             remove the files that have been generated by the build process
-->

<project name="jpf-bmc" default="build" basedir=".">

  <!-- ========================== COMMON SECTION ========================== -->

  <!--
    local props have to come first, because Ant properties are immutable
    NOTE: this file is local - it is never in the repository!
  -->

  <!-- this is where we get the 'jpf.core' location from -->
  <!-- <property file="${user.home}/.jpf/site.properties"/> -->

  <!-- if there is none, default to a 'jpf-core' peer dir -->
  <property name="jpf-core" value = "../jpf-core"/>

  <!-- get the jpf-core path properties -->
  <property file="${jpf-core}/jpf.properties"/>

  <!-- if there is none, default to a 'jpf-core' peer dir -->
  <property name="jpf-symbc" value = "../jpf-symbc"/>

  <!-- get the jpf-symbc path properties -->
  <property file="${jpf-symbc}/jpf.properties"/>


  <!-- compiler settings -->
  <property name="src_level"     value="6"/>
  <property name="debug"         value="on"/>
  <property name="deprecation"   value="on"/>


  <!-- generic classpath settings -->
  <path id="lib.path">

    <!-- our own classes and libs come first -->
    <pathelement location="build/main"/>
    <!-- we don't have these
    <pathelement location="build/peers"/>
    -->
    <fileset dir=".">
  	    <include name="lib/*.jar"/>
    </fileset>

    <!-- add in what we need from the core -->
    <pathelement path="${jpf-core.native_classpath}"/>

    <!-- add in what we need from the symbc -->
    <pathelement path="${jpf-symbc.native_classpath}"/>
    <pathelement path="${jpf-symbc.classpath}"/>

  </path>

  <!-- init: common initialization -->
  <target name="-init">
    <tstamp/>

    <mkdir dir="build"/>               <!-- the build root -->

    <!-- the things that have to be in the classpath of whatever runs Ant -->
    <available property="have_javac" classname="com.sun.tools.javac.Main"/>
    <fail unless="have_javac">no javac found</fail>


    <available file="src/main"        type="dir" property="have_main"/>
    <available file="src/tests"       type="dir" property="have_tests"/>
    <available file="src/examples"    type="dir" property="have_examples"/>

    <condition property="have_jvm_code">
      <or>
        <isset property="have_main"/>
        <isset property="have_peers"/>
      </or>
    </condition>

    <condition property="have_jpf_code">
      <or>
        <isset property="have_classes"/>
        <isset property="have_annotations"/>
      </or>
    </condition>

  </target>


  <!-- ======================= COMPILE SECTION ============================= -->

  <!-- public compile -->
  <target name="compile" depends="-init,-compile-main,-compile-tests,-compile-examples"
          description="compile all JPF core sources" >
  </target>

  <target name="-compile-main" if="have_main">
    <mkdir dir="build/main"/>
    <!--TODO: remove src/examples from srcdir after configuring dynamically program inputs-->
    <javac srcdir="src/main" destdir="build/main" includeantruntime="false"
           debug="${debug}" source="${src_level}" deprecation="${deprecation}"
           classpathref="lib.path"/>
  </target>

  <target name="-compile-tests" if="have_tests" depends="-compile-main">
    <mkdir dir="build/tests"/>
    <javac srcdir="src/tests" destdir="build/tests" includeantruntime="false"
           debug="${debug}" source="${src_level}" deprecation="${deprecation}">
      <classpath>
        <path refid="lib.path"/>
        <pathelement location="build/classes"/>
        <pathelement location="build/annotations"/>
      </classpath>
    </javac>
  </target>

  <target name="-compile-examples" if="have_examples" depends="-compile-main">
    <mkdir dir="build/examples" />
    <javac srcdir="src/examples" destdir="build/examples" includeantruntime="false"
           debug="${debug}" source="${src_level}" deprecation="${deprecation}">
    <classpath>
        <path refid="lib.path"/>
        <pathelement location="build/classes"/>
      <pathelement location="build/annotations"/>
     </classpath>
    </javac>
    </target>

  <!-- ======================= MISC SECTION ================================ -->

  <!-- build jars -->
  <target name="build" depends="compile,-jar-jvm,-jar-tool,create-tmp-dir"
        description="generate the ${ant.project.name} jar files" >
  </target>
  
  <target name="-jar-jvm" if="have_jvm_code">
    <jar jarfile="build/${ant.project.name}.jar">
      <fileset dir="build/main"/>	
      <manifest>
	<attribute name="Main-Class" value="uk.ac.qmul.bmc.tool.RunBMC" />
      </manifest>
    </jar>
    <chmod file="build/${ant.project.name}.jar" perm="ugo+rx"/>
  </target>

  <!-- Target #1. Set property value depends on check result -->
  <target name="check-dir">
    <available property="tmp.dir" file="build/tmp" type="dir"/>
  </target>

  <!-- target #2. Create dir 'tmp' if doesn't exist -->
  <target name="create-tmp-dir" depends="check-dir" unless="tmp.dir">
    <mkdir dir="build/tmp"/>
  </target>

  <target name="-jar-tool" if="have_jvm_code">
    <jar jarfile="build/RunBMC.jar">
      <fileset dir="build/main">
	<include name="uk/ac/qmul/bmc/tool/RunBMC.class"/>
      </fileset>
      <fileset dir="${jpf-core}/build/main">

        <include name="gov/nasa/jpf/tool/Run.class"/>
        <include name="gov/nasa/jpf/Config.class"/>
        <include name="gov/nasa/jpf/ConfigChangeListener.class"/>
        <include name="gov/nasa/jpf/Config$MissingRequiredKeyException.class"/>
        <include name="gov/nasa/jpf/JPFClassLoader.class"/>
        <include name="gov/nasa/jpf/JPFException.class"/>
        <include name="gov/nasa/jpf/JPFConfigException.class"/>
        <include name="gov/nasa/jpf/util/JPFSiteUtils.class"/>
        <include name="gov/nasa/jpf/util/FileUtils.class"/>
        <include name="gov/nasa/jpf/util/StringMatcher.class"/>
        <include name="gov/nasa/jpf/util/Pair.class"/>   
	
      </fileset>
      <manifest>
	<attribute name="Main-Class" value="uk.ac.qmul.bmc.tool.RunBMC" />
      </manifest>
    </jar>
    <chmod file="build/RunBMC.jar" perm="ugo+rx"/>
  </target>

  <!-- public clean: cleanup from previous tasks/builds -->
  <target name="clean">
    <delete dir="build" />
    <delete>
      <fileset dir="." includes="**/*~" defaultexcludes="no" />
      <fileset dir="." includes="**/*.bak" defaultexcludes="no" />
      <fileset dir="." includes="**/error.xml" />
    </delete>
  </target>

</project>
